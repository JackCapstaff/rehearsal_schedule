{% extends "base.html" %}
{% set title = "Invitation Codes" %}
{% set subtitle = ensemble.name %}

{% block content %}
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:baseline; gap:12px;">
      <div>
        <div class="small">Managing invitations for</div>
        <strong>{{ ensemble.name }}</strong>
      </div>
      <div>
        <a class="btn secondary" href="{{ url_for('admin_home') }}">Back to Admin</a>
      </div>
    </div>
  </div>

  <div class="card">
    <strong>Create New Invitation</strong>
    
    <form method="post" action="{{ url_for('admin_create_invitation', ensemble_id=ensemble.id) }}" style="margin-top:12px; display:flex; flex-direction:column; gap:12px;">
      <div style="display:flex; gap:12px; align-items:center;">
        <label style="flex:1;">
          <div class="small">Expires in (days):</div>
          <input type="number" name="expires_days" value="30" min="1" max="365" required style="padding:10px; width:100%;">
        </label>
        
        <label style="flex:1;">
          <div class="small">Maximum uses:</div>
          <input type="number" name="max_uses" value="10" min="1" max="1000" required style="padding:10px; width:100%;">
        </label>
        
        <button class="btn" type="submit" style="margin-top:20px;">Generate Code</button>
      </div>
    </form>
  </div>

  <div class="card">
    <strong>Active Invitations</strong>
    
    {% if invitations %}
      <div style="margin-top:14px;">
        {% for invite in invitations %}
          {% set now = (None|int if None else 0) %}
          {% set is_expired = invite.expires_at < (None|int if None else 0) %}
          {% set is_exhausted = invite.used_count >= invite.max_uses %}
          {% set is_disabled = invite.status == "disabled" %}
          
          <div style="border-top:1px solid #eee; padding:14px 0;">
            <div style="display:flex; justify-content:space-between; gap:12px; align-items:start;">
              <div style="flex:1;">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
                  <code style="background:#f3f4f6; padding:6px 12px; border-radius:4px; font-size:16px; font-weight:600;">{{ invite.code }}</code>
                  <a class="btn secondary" style="padding:4px 12px;" href="{{ invite.invite_url }}" target="_blank" rel="noopener">Open link</a>
                  <button class="btn secondary" style="padding:4px 12px;" onclick="copyInviteLink('{{ invite.invite_url }}')">üìã Copy Link</button>
                  
                  {% if is_disabled %}
                    <span style="color:#ef4444; font-weight:600;">üö´ Disabled</span>
                  {% elif is_expired %}
                    <span style="color:#f59e0b; font-weight:600;">‚è∞ Expired</span>
                  {% elif is_exhausted %}
                    <span style="color:#f59e0b; font-weight:600;">‚úÖ Fully Used</span>
                  {% else %}
                    <span style="color:#10b981; font-weight:600;">‚úì Active</span>
                  {% endif %}
                </div>
                
                <div class="small" style="margin-top:6px;">
                  <div>Created: {{ invite.created_at|timestamp_to_date }}</div>
                  <div>Expires: {{ invite.expires_at|timestamp_to_date }}</div>
                  <div>Usage: {{ invite.used_count }} / {{ invite.max_uses }}</div>
                  <div style="margin-top:4px; word-break:break-all;">Link: <a href="{{ invite.invite_url }}" target="_blank" rel="noopener">{{ invite.invite_url }}</a></div>
                </div>
              </div>
              
              {% if not is_disabled %}
                <form method="post" action="{{ url_for('admin_disable_invitation', invitation_id=invite.id) }}">
                  <button class="btn secondary" type="submit" style="background:#ef4444; color:white;">Disable</button>
                </form>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="small" style="margin-top:12px;">No invitations yet. Create one above to invite new members.</div>
    {% endif %}
  </div>

  <script>
    function copyInviteLink(url) {
      navigator.clipboard.writeText(url).then(() => {
        alert('Invitation link copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy:', err);
        prompt('Copy this link:', url);
      });
    }
  </script>
{% endblock %}
