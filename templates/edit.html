{% extends "base.html" %}
{% set title = "Edit Schedule" %}
{% set subtitle = schedule_name if schedule_name else "Schedule editor" %}

{% block content %}
<body data-schedule-id="{{ schedule_id }}">

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:baseline; gap:12px;">
      <div>
        <div class="small">Schedule</div>
        <strong>{{ schedule_name }}</strong>
        <div class="small" style="margin-top:4px;">
          Ensemble: {{ ensemble_name }} Â· Status: <strong>{{ status }}</strong>
        </div>
        <div class="small" style="margin-top:8px; color:#f59e0b; font-style:italic;">
          ðŸ’¾ Changes auto-save Â· ðŸ”„ Members must refresh their view to see updates
        </div>
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <a class="btn secondary" href="{{ url_for('admin_home') }}">
          <i class="bi bi-arrow-left"></i> Back to Admin
        </a>
        <a class="btn secondary" href="{{ url_for('my_view') }}">Back to My</a>

        {% if status == "draft" %}
          <form method="post" action="{{ url_for('admin_set_schedule_status', schedule_id=schedule_id) }}">
            <input type="hidden" name="status" value="published">
            <label class="small" style="display:inline-flex; align-items:center; gap:6px; margin-right:8px;">
              <input type="checkbox" name="notify_publish" checked>
              Email members about publish
            </label>
            <button class="btn" type="submit">Publish</button>
          </form>
        {% else %}
          <form method="post" action="{{ url_for('admin_set_schedule_status', schedule_id=schedule_id) }}">
            <input type="hidden" name="status" value="draft">
            <button class="btn secondary" type="submit">Unpublish</button>
          </form>
        {% endif %}

        <a class="btn secondary" href="{{ url_for('schedule_view', schedule_id=schedule_id) }}">View</a>
        
        <button class="btn secondary" onclick="document.getElementById('upload-complete-schedule').click();">
          ðŸ“¤ Upload Complete Schedule
        </button>
        <form id="upload-complete-schedule-form" style="display:none;">
          <input type="file" id="upload-complete-schedule" accept=".xlsx" onchange="handleCompleteScheduleUpload('{{ schedule_id }}', this.files[0])">
        </form>
        
        <form method="post" action="{{ url_for('admin_delete_schedule', schedule_id=schedule_id) }}" 
              onsubmit="return confirm('Are you sure you want to delete this schedule? This action cannot be undone.');" 
              style="display:inline;">
          <button class="btn" type="submit" style="background-color: #dc2626; border-color: #dc2626;">
            <i class="bi bi-trash"></i> Delete Schedule
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Notify modal -->
  <div id="notifyModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:white; padding:16px; border-radius:6px; min-width:320px; max-width:520px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div style="font-weight:600;">Select recipients</div>
        <button class="btn secondary" type="button" onclick="closeNotifyModal()">Close</button>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px;">
        <div class="small">Recipients</div>
        <div style="display:flex; gap:6px;">
          <button class="btn secondary" type="button" onclick="toggleRecipients()" id="toggleRecipientsBtn">Edit recipients</button>
          <button class="btn secondary" type="button" onclick="selectAllRecipients(true)">Select all</button>
          <button class="btn secondary" type="button" onclick="selectAllRecipients(false)">Clear all</button>
        </div>
      </div>
      <div id="notifyRecipientList" style="max-height:320px; overflow-y:auto; margin-bottom:12px; border:1px solid #e5e7eb; padding:8px; border-radius:4px;"></div>
      <div style="margin-bottom:12px; display:flex; flex-direction:column; gap:6px;">
        <label class="small">Add custom recipient</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="email" id="notifyCustomEmail" placeholder="name@example.com" style="flex:1; padding:8px; border:1px solid #d1d5db; border-radius:4px;">
          <button class="btn secondary" type="button" onclick="addCustomRecipient()">Add</button>
        </div>
        <div id="customRecipientChips" class="small" style="display:flex; gap:6px; flex-wrap:wrap;"></div>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px;">
        <div>
          <div class="small" style="margin-bottom:4px;">Subject</div>
          <input type="text" id="notifySubject" placeholder="Subject" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:4px;">
        </div>
        <div>
          <div class="small" style="margin-bottom:4px; display:flex; justify-content:space-between; align-items:center; gap:8px;">
            <span>Email message</span>
            <span style="display:flex; gap:6px; align-items:center;">
              <button class="btn secondary" type="button" onclick="formatSelection('b')" title="Bold"><strong>B</strong></button>
              <button class="btn secondary" type="button" onclick="formatSelection('i')" title="Italic"><em>I</em></button>
              <button class="btn secondary" type="button" onclick="formatSelection('u')" title="Underline"><u>U</u></button>
              <button class="btn secondary" type="button" onclick="insertBulletList()" title="Bulleted list">â€¢ List</button>
            </span>
          </div>
          <textarea id="notifyBody" rows="10" placeholder="There have been some updates..." style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:4px; font-family: 'Segoe UI', sans-serif; line-height:1.4;"></textarea>
          <div class="small" style="color:#6b7280; margin-top:4px;">Basic formatting allowed: bold, italic, underline, bullet lists. Updates list and schedule link are added automatically.</div>
        </div>
        <div id="notifyLinkPreview" class="small" style="color:#374151;"></div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:8px;">
        <button class="btn secondary" type="button" onclick="closeNotifyModal()">Cancel</button>
        <button class="btn" type="button" id="notifyModalSend">Send</button>
      </div>
    </div>
  </div>

  <div class="card">
    <strong>Import</strong>
    <div class="small" style="margin-top:6px;">
        Upload one Excel file (.xlsx) containing <strong>Works</strong> and <strong>Rehearsals</strong> (separate sheets).
    </div>

    <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:end;">
        <div>
        <div class="small">Excel file</div>
        <input type="file" id="xlsxFile" accept=".xlsx">
        </div>
        <div>
        <button class="btn secondary" type="button" onclick="uploadXlsx()">Upload</button>
        </div>
    </div>

    <div id="importMsg" class="small" style="margin-top:10px;"></div>
  </div>
 

  <!-- ===================== -->
  <!-- Works input table     -->
  <!-- ===================== -->
  <div class="card">
    <h3>Works</h3>
    <div id="importMsg" class="msg"></div>
    <div class="table-wrap">
      <div id="works-table"></div>
    </div>
    <button class="btn secondary" onclick="addWorkRow()">Add work</button>
  </div>
  <!-- ===================== -->
  <!-- Events table          -->
  <!-- ===================== -->
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <h3 style="margin:0;">Events (Rehearsals, Concerts, Sectionals)</h3>
      <button class="btn secondary" onclick="refreshFromServer()" style="padding:6px 12px;">ðŸ”„ Refresh</button>
    </div>
    <div class="table-wrap">
      <div id="rehearsals-table"></div>
    </div>
    <button class="btn secondary" onclick="addEventRow()">Add event</button>
  </div>

  <!-- ===================== -->
  <!-- Allocation + schedule controls -->
  <!-- ===================== -->
  <div class="card">
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" onclick="runAllocation()">Run allocation</button>
      <button class="btn" onclick="generateSchedule()">Generate schedule</button>
      <button class="btn secondary" onclick="recomputeTimed()">Recompute timings</button>
    </div>
  </div>

  <!-- ===================== -->
  <!-- Allocation results    -->
  <!-- ===================== -->
  <div class="card" style="padding:0;">
    <div class="accordion-header collapsed" onclick="toggleAccordion(this)">
      <span class="toggle-icon">â–¼</span>
      <span>Allocation</span>
    </div>
    <div class="accordion-content" style="display: none; padding:20px;">
      <div id="allocation-table"></div>
    </div>
  </div>

  <!-- ===================== -->
  <!-- Schedule output       -->
  <!-- ===================== -->
  <div class="card" style="padding:0;">
    <div class="accordion-header collapsed" onclick="toggleAccordion(this)">
      <span class="toggle-icon">â–¼</span>
      <span>Schedule</span>
    </div>
    <div class="accordion-content" style="display: none; padding:20px;">
      <div id="schedule-table"></div>
    </div>
  </div>

  <!-- ===================== -->
  <!-- Timeline Editor       -->
  <!-- ===================== -->
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:10px; flex-wrap:wrap;">
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
        <h3 style="margin:0;">Timeline Editor</h3>
        <button class="btn secondary" type="button" onclick="toggleHistoryPanel()" style="padding:6px 12px;">ðŸ“‹ History</button>
      </div>
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
        <button class="btn secondary" type="button" onclick="openNotifyModal()">Send updates</button>
      </div>
    </div>
    <div class="small" style="margin-bottom:12px;">Drag works to reorder, drag edges to resize. Auto-saves with change log. Use "Send updates" to email members.</div>
    
    <!-- History Panel (hidden by default) -->
    <div id="historyPanel" style="display:none; margin-bottom:16px; padding:12px; background:#f5f5f5; border-radius:4px; max-height:300px; overflow-y:auto;">
      <div style="font-weight:bold; margin-bottom:8px;">Change History</div>
      <div id="historyList" style="font-size:0.85rem;"></div>
    </div>

    <!-- Timeline grid -->
    <div id="timelineEditor" style="margin-top:12px; background:white; border:1px solid #ddd; border-radius:4px; overflow-x:auto;">
      <div id="timelineContent"></div>
    </div>
  </div>

</body>

<!-- Editor logic -->
<script src="{{ url_for('static', filename='editor.js') }}"></script>

<script>
  // Bootstrap initial data from Flask â†’ editor.js
  window.INITIAL_DATA = {
    works: {{ works | tojson }},
    works_cols: {{ works_cols | tojson }},
    rehearsals: {{ rehearsals | tojson }},
    rehearsals_cols: {{ rehearsals_cols | tojson }},
    allocation: {{ allocation | tojson }},
    schedule: {{ schedule | tojson }},
    timed: {{ timed | tojson }},
    concerts: {{ concerts | tojson }},  // Add concerts for timeline editor
  };

  // Let editor.js initialise tables
  initEditor(window.INITIAL_DATA);

  let lastDefaultSubject = "";
  let lastDefaultBody = "";
  let currentScheduleLink = "";
  let customRecipients = [];

  async function readJsonOrThrow(res) {
    const ct = res.headers.get('content-type') || '';
    if (ct.includes('application/json')) return res.json();
    const text = await res.text();
    throw new Error(`Unexpected response (${res.status}): ${text.slice(0, 200)}`);
  }

  // Notification modal helpers
  async function openNotifyModal() {
    customRecipients = [];
    renderCustomRecipientChips();
    const modal = document.getElementById('notifyModal');
    const list = document.getElementById('notifyRecipientList');
    const subjectInput = document.getElementById('notifySubject');
    const bodyInput = document.getElementById('notifyBody');
    if (!modal || !list) return;

    list.innerHTML = '<div class="small">Loading recipientsâ€¦</div>';
    modal.style.display = 'block';

    try {
      const res = await fetch(`/api/s/{{ schedule_id }}/notify_update`, { method: 'GET', credentials: 'same-origin' });
      const data = await readJsonOrThrow(res);
      if (!res.ok || !data.ok) {
        throw new Error(data.error || `Unable to load recipients (status ${res.status})`);
      }

      if (!data.recipients || data.recipients.length === 0) {
        list.innerHTML = '<div class="small">No recipients for this ensemble.</div>';
        return;
      }

      lastDefaultSubject = data.default_subject || '';
      lastDefaultBody = data.default_body || '';
      currentScheduleLink = data.schedule_link || '';
      if (subjectInput) subjectInput.value = lastDefaultSubject;
      if (bodyInput) bodyInput.value = lastDefaultBody;
      const linkPreview = document.getElementById('notifyLinkPreview');
      if (linkPreview) {
        if (currentScheduleLink) {
          linkPreview.innerHTML = `Schedule link: <a href="${currentScheduleLink}" target="_blank" rel="noopener">${currentScheduleLink}</a>`;
        } else {
          linkPreview.textContent = '';
        }
      }

      list.innerHTML = data.recipients.map(r => `
        <label style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid #f0f0f0;">
          <input type="checkbox" class="notify-recipient" value="${r.email}" checked>
          <span>
            <div><strong>${r.email}</strong></div>
            <div class="small" style="color:#666;">${r.status || ''}</div>
          </span>
        </label>
      `).join('');
      document.getElementById('notifyModalSend').onclick = () => sendSelectedNotifications();
    } catch (err) {
      console.error('Load recipients failed:', err);
      list.innerHTML = `<div class="small" style="color:#dc2626;">${err.message}</div>`;
    }
  }

  function closeNotifyModal() {
    const modal = document.getElementById('notifyModal');
    if (modal) modal.style.display = 'none';
  }

  function toggleRecipients() {
    const list = document.getElementById('notifyRecipientList');
    const btn = document.getElementById('toggleRecipientsBtn');
    if (!list || !btn) return;
    const isHidden = list.style.display === 'none';
    list.style.display = isHidden ? 'block' : 'none';
    btn.textContent = isHidden ? 'Hide recipients' : 'Edit recipients';
  }

  function selectAllRecipients(selectAll) {
    document.querySelectorAll('.notify-recipient').forEach(cb => {
      cb.checked = !!selectAll;
    });
  }

  function renderCustomRecipientChips() {
    const chips = document.getElementById('customRecipientChips');
    if (!chips) return;
    if (!customRecipients.length) {
      chips.innerHTML = '<span style="color:#6b7280;">No custom recipients added.</span>';
      return;
    }
    chips.innerHTML = customRecipients.map(email => `
      <span style="display:inline-flex; align-items:center; gap:6px; background:#e5e7eb; padding:4px 8px; border-radius:12px;">
        <span>${email}</span>
        <button type="button" style="border:none; background:none; cursor:pointer; color:#ef4444;" aria-label="Remove ${email}" onclick="removeCustomRecipient('${email}')">Ã—</button>
      </span>
    `).join('');
  }

  function addCustomRecipient() {
    const input = document.getElementById('notifyCustomEmail');
    if (!input) return;
    const email = (input.value || '').trim();
    if (!email) return;
    if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
      alert('Please enter a valid email address');
      return;
    }
    if (!customRecipients.includes(email)) {
      customRecipients.push(email);
      renderCustomRecipientChips();
    }
    input.value = '';
  }

  function removeCustomRecipient(email) {
    customRecipients = customRecipients.filter(e => e !== email);
    renderCustomRecipientChips();
  }

  function formatSelection(tag) {
    const ta = document.getElementById('notifyBody');
    if (!ta) return;
    const start = ta.selectionStart;
    const end = ta.selectionEnd;
    const before = ta.value.substring(0, start);
    const selected = ta.value.substring(start, end) || 'text';
    const after = ta.value.substring(end);
    const openTag = `<${tag}>`;
    const closeTag = `</${tag}>`;
    ta.value = before + openTag + selected + closeTag + after;
    const cursorPos = before.length + openTag.length + selected.length + closeTag.length;
    ta.focus();
    ta.setSelectionRange(cursorPos, cursorPos);
  }

  function insertBulletList() {
    const ta = document.getElementById('notifyBody');
    if (!ta) return;
    const start = ta.selectionStart;
    const end = ta.selectionEnd;
    const before = ta.value.substring(0, start);
    const selected = ta.value.substring(start, end) || 'Item 1\nItem 2';
    const after = ta.value.substring(end);
    const listHtml = `<ul>\n<li>${selected.replace(/\n/g, '</li>\n<li>')}</li>\n</ul>`;
    ta.value = before + listHtml + after;
    const cursorPos = before.length + listHtml.length;
    ta.focus();
    ta.setSelectionRange(cursorPos, cursorPos);
  }

  async function sendSelectedNotifications() {
    const checked = Array.from(document.querySelectorAll('.notify-recipient:checked')).map(cb => cb.value);
    const recipients = [...checked, ...customRecipients].filter(Boolean);
    const subjectInput = document.getElementById('notifySubject');
    const bodyInput = document.getElementById('notifyBody');
    const subject = (subjectInput && subjectInput.value.trim()) || lastDefaultSubject || 'Schedule updates';
    const message = (bodyInput && bodyInput.value.trim()) || lastDefaultBody || 'Schedule updated';

    try {
      const res = await fetch(`/api/s/{{ schedule_id }}/notify_update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ subject, body: message, recipients })
      });
      const result = await readJsonOrThrow(res);
      if (!res.ok || !result.ok) {
        throw new Error(result.error || `Notification failed (status ${res.status})`);
      }
      if (result.notified) {
        alert(`Emails sent to ${result.recipient_count} recipient(s).`);
      } else {
        alert(result.error || 'No recipients or email disabled.');
      }
      closeNotifyModal();
    } catch (err) {
      console.error('Notify failed:', err);
      alert('Failed to send updates: ' + err.message);
    }
  }
  
  // Populate sections editor
  function renderSectionsEditor() {
    const sectionsDiv = document.getElementById('sections-editor');
    if (!sectionsDiv) return;
    
    const rehearsals = window.INITIAL_DATA.rehearsals || [];
    
    // Sort by rehearsal number
    const sorted = rehearsals.sort((a, b) => {
      const numA = parseInt(a.Rehearsal);
      const numB = parseInt(b.Rehearsal);
      return numA - numB;
    });
    
    sectionsDiv.innerHTML = sorted.map(reh => `
      <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px; padding: 10px; background: #f9fafb; border-radius: 4px;">
        <div style="flex: 1;">
          <strong>Rehearsal ${reh.Rehearsal}</strong><br>
          <small style="color: #666;">${reh.Date || 'Date not set'}</small>
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <div>
            <label style="display: block; font-size: 0.85rem; margin-bottom: 4px; color: #666;">Event Type</label>
            <select class="event-type-input" data-rehearsal="${reh.Rehearsal}" 
                    style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
              <option value="Rehearsal" ${reh['Event Type'] === 'Rehearsal' ? 'selected' : ''}>Rehearsal</option>
              <option value="Sectional" ${reh['Event Type'] === 'Sectional' ? 'selected' : ''}>Sectional</option>
              <option value="Concert" ${reh['Event Type'] === 'Concert' ? 'selected' : ''}>Concert</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-size: 0.85rem; margin-bottom: 4px; color: #666;">Section</label>
            <input type="text" class="section-input" data-rehearsal="${reh.Rehearsal}" 
                   value="${reh.Section || 'Full Ensemble'}" placeholder="Full Ensemble"
                   style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; width: 180px;">
          </div>
          <button onclick="saveEventTypeAndSection(${reh.Rehearsal})" class="btn btn-sm" style="padding: 6px 12px; align-self: flex-end;">Save</button>
        </div>
      </div>
    `).join('');
  }
  
  // Save event type and section change
  async function saveEventTypeAndSection(rehearsalNum) {
    const eventTypeSelect = document.querySelector(`.event-type-input[data-rehearsal="${rehearsalNum}"]`);
    const sectionInput = document.querySelector(`.section-input[data-rehearsal="${rehearsalNum}"]`);
    if (!eventTypeSelect || !sectionInput) return;
    
    const eventType = eventTypeSelect.value.trim();
    const section = sectionInput.value.trim() || 'Full Ensemble';
    
    try {
      const response = await fetch(`/api/s/{{ schedule_id }}/rehearsal-event-type/${rehearsalNum}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 'Event Type': eventType, 'Section': section })
      });
      
      if (response.ok) {
        // Update STATE
        const rehearsal = STATE.rehearsals.find(r => parseInt(r.Rehearsal) === rehearsalNum);
        if (rehearsal) {
          rehearsal['Event Type'] = eventType;
          rehearsal['Section'] = section;
        }
        // Also update timed data
        STATE.timed.forEach(row => {
          if (parseInt(row.Rehearsal) === rehearsalNum) {
            row.Section = section;
          }
        });
        alert('Event type and section updated!');
      } else {
        alert('Error updating event type and section');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to update event type and section');
    }
  }
  
  async function handleCompleteScheduleUpload(scheduleId, file) {
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      const response = await fetch(`/api/s/${scheduleId}/import_complete_schedule`, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
      });
      
      if (response.ok) {
        const result = await response.json();
        alert(`Success! Uploaded ${result.rehearsals_rows} rehearsals and ${result.timed_rows} scheduled works.`);
        location.reload();
      } else {
        const error = await response.json();
        alert('Error: ' + (error.error || 'Failed to upload'));
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to upload: ' + error.message);
    }
    
    // Reset file input
    document.getElementById('upload-complete-schedule-form').reset();
  }
  
  // Render sections when page loads
  setTimeout(() => {
    renderSectionsEditor();
  }, 500);
</script>
{% endblock %}
