{% extends "base.html" %}
{% set title = "Edit Schedule" %}
{% set subtitle = schedule_name if schedule_name else "Schedule editor" %}

{% block content %}
<body data-schedule-id="{{ schedule_id }}">

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:baseline; gap:12px;">
      <div>
        <div class="small">Schedule</div>
        <strong>{{ schedule_name }}</strong>
        <div class="small" style="margin-top:4px;">
          Ensemble: {{ ensemble_name }} Â· Status: <strong>{{ status }}</strong>
        </div>
        <div class="small" style="margin-top:8px; color:#f59e0b; font-style:italic;">
          ðŸ’¾ Changes auto-save Â· ðŸ”„ Members must refresh their view to see updates
        </div>
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <a class="btn secondary" href="{{ url_for('my_view') }}">Back to My</a>

        {% if status == "draft" %}
          <form method="post" action="{{ url_for('admin_set_schedule_status', schedule_id=schedule_id) }}">
            <input type="hidden" name="status" value="published">
            <button class="btn" type="submit">Publish</button>
          </form>
        {% else %}
          <form method="post" action="{{ url_for('admin_set_schedule_status', schedule_id=schedule_id) }}">
            <input type="hidden" name="status" value="draft">
            <button class="btn secondary" type="submit">Unpublish</button>
          </form>
        {% endif %}

        <a class="btn secondary" href="{{ url_for('schedule_view', schedule_id=schedule_id) }}">View</a>
      </div>
    </div>
  </div>

  <div class="card">
    <strong>Import</strong>
    <div class="small" style="margin-top:6px;">
        Upload one Excel file (.xlsx) containing <strong>Works</strong> and <strong>Rehearsals</strong> (separate sheets).
    </div>

    <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:end;">
        <div>
        <div class="small">Excel file</div>
        <input type="file" id="xlsxFile" accept=".xlsx">
        </div>
        <div>
        <button class="btn secondary" type="button" onclick="uploadXlsx()">Upload</button>
        </div>
    </div>

    <div id="importMsg" class="small" style="margin-top:10px;"></div>
  </div>
 

  <!-- ===================== -->
  <!-- Works input table     -->
  <!-- ===================== -->
  <div class="card">
    <h3>Works</h3>
    <div id="importMsg" class="msg"></div>
    <div class="table-wrap">
      <div id="works-table"></div>
    </div>
    <button class="btn secondary" onclick="addWorkRow()">Add work</button>
  </div>
  <!-- ===================== -->
  <!-- Rehearsals table      -->
  <!-- ===================== -->
  <div class="card">
    <h3>Rehearsals</h3>
    <div class="table-wrap">
      <div id="rehearsals-table"></div>
    </div>
    <button class="btn secondary" onclick="addRehearsalRow()">Add rehearsal</button>
  </div>

  <!-- ===================== -->
  <!-- Allocation + schedule controls -->
  <!-- ===================== -->
  <div class="card">
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" onclick="runAllocation()">Run allocation</button>
      <button class="btn" onclick="generateSchedule()">Generate schedule</button>
      <button class="btn secondary" onclick="recomputeTimed()">Recompute timings</button>
    </div>
  </div>

  <!-- ===================== -->
  <!-- Allocation results    -->
  <!-- ===================== -->
  <div class="card" style="padding:0;">
    <div class="accordion-header collapsed" onclick="toggleAccordion(this)">
      <span class="toggle-icon">â–¼</span>
      <span>Allocation</span>
    </div>
    <div class="accordion-content hidden" style="padding:20px;">
      <div id="allocation-table"></div>
    </div>
  </div>

  <!-- ===================== -->
  <!-- Schedule output       -->
  <!-- ===================== -->
  <div class="card" style="padding:0;">
    <div class="accordion-header collapsed" onclick="toggleAccordion(this)">
      <span class="toggle-icon">â–¼</span>
      <span>Schedule</span>
    </div>
    <div class="accordion-content hidden" style="padding:20px;">
      <div id="schedule-table"></div>
    </div>
  </div>

  <!-- ===================== -->
  <!-- Timeline Editor       -->
  <!-- ===================== -->
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <h3 style="margin:0;">Timeline Editor</h3>
      <button class="btn secondary" type="button" onclick="toggleHistoryPanel()" style="padding:6px 12px;">ðŸ“‹ History</button>
    </div>
    <div class="small" style="margin-bottom:12px;">Drag works to reorder, drag edges to resize. Auto-saves with change log.</div>
    
    <!-- History Panel (hidden by default) -->
    <div id="historyPanel" style="display:none; margin-bottom:16px; padding:12px; background:#f5f5f5; border-radius:4px; max-height:300px; overflow-y:auto;">
      <div style="font-weight:bold; margin-bottom:8px;">Change History</div>
      <div id="historyList" style="font-size:0.85rem;"></div>
    </div>

    <!-- Timeline grid -->
    <div id="timelineEditor" style="margin-top:12px; background:white; border:1px solid #ddd; border-radius:4px; overflow-x:auto;">
      <div id="timelineContent"></div>
    </div>
  </div>

</body>

<!-- Editor logic -->
<script src="{{ url_for('static', filename='editor.js') }}"></script>

<script>
  // Bootstrap initial data from Flask â†’ editor.js
  window.INITIAL_DATA = {
    works: {{ works | tojson }},
    works_cols: {{ works_cols | tojson }},
    rehearsals: {{ rehearsals | tojson }},
    rehearsals_cols: {{ rehearsals_cols | tojson }},
    allocation: {{ allocation | tojson }},
    schedule: {{ schedule | tojson }},
    timed: {{ timed | tojson }},
  };

  // Let editor.js initialise tables
  initEditor(window.INITIAL_DATA);
</script>
{% endblock %}
