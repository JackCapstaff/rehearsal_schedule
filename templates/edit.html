{% extends "base.html" %}
{% set title = "Edit Schedule" %}
{% set subtitle = schedule_name if schedule_name else "Schedule editor" %}

{% block content %}
<body data-schedule-id="{{ schedule_id }}">

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:baseline; gap:12px;">
      <div>
        <div class="small">Schedule</div>
        <strong>{{ schedule_name }}</strong>
        <div class="small" style="margin-top:4px;">
          Ensemble: {{ ensemble_name }} Â· Status: <strong>{{ status }}</strong>
        </div>
        <div class="small" style="margin-top:8px; color:#f59e0b; font-style:italic;">
          ðŸ’¾ Changes auto-save Â· ðŸ”„ Members must refresh their view to see updates
        </div>
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <a class="btn secondary" href="{{ url_for('admin_home') }}">
          <i class="bi bi-arrow-left"></i> Back to Admin
        </a>
        <a class="btn secondary" href="{{ url_for('my_view') }}">Back to My</a>

        {% if status == "draft" %}
          <form method="post" action="{{ url_for('admin_set_schedule_status', schedule_id=schedule_id) }}">
            <input type="hidden" name="status" value="published">
            <button class="btn" type="submit">Publish</button>
          </form>
        {% else %}
          <form method="post" action="{{ url_for('admin_set_schedule_status', schedule_id=schedule_id) }}">
            <input type="hidden" name="status" value="draft">
            <button class="btn secondary" type="submit">Unpublish</button>
          </form>
        {% endif %}

        <a class="btn secondary" href="{{ url_for('schedule_view', schedule_id=schedule_id) }}">View</a>
        
        <button class="btn secondary" onclick="document.getElementById('upload-complete-schedule').click();">
          ðŸ“¤ Upload Complete Schedule
        </button>
        <form id="upload-complete-schedule-form" style="display:none;">
          <input type="file" id="upload-complete-schedule" accept=".xlsx" onchange="handleCompleteScheduleUpload('{{ schedule_id }}', this.files[0])">
        </form>
        
        <form method="post" action="{{ url_for('admin_delete_schedule', schedule_id=schedule_id) }}" 
              onsubmit="return confirm('Are you sure you want to delete this schedule? This action cannot be undone.');" 
              style="display:inline;">
          <button class="btn" type="submit" style="background-color: #dc2626; border-color: #dc2626;">
            <i class="bi bi-trash"></i> Delete Schedule
          </button>
        </form>
      </div>
    </div>
  </div>

  <div class="card">
    <strong>Import</strong>
    <div class="small" style="margin-top:6px;">
        Upload one Excel file (.xlsx) containing <strong>Works</strong> and <strong>Rehearsals</strong> (separate sheets).
    </div>

    <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:end;">
        <div>
        <div class="small">Excel file</div>
        <input type="file" id="xlsxFile" accept=".xlsx">
        </div>
        <div>
        <button class="btn secondary" type="button" onclick="uploadXlsx()">Upload</button>
        </div>
    </div>

    <div id="importMsg" class="small" style="margin-top:10px;"></div>
  </div>
 

  <!-- ===================== -->
  <!-- Works input table     -->
  <!-- ===================== -->
  <div class="card">
    <h3>Works</h3>
    <div id="importMsg" class="msg"></div>
    <div class="table-wrap">
      <div id="works-table"></div>
    </div>
    <button class="btn secondary" onclick="addWorkRow()">Add work</button>
  </div>
  <!-- ===================== -->
  <!-- Events table          -->
  <!-- ===================== -->
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <h3 style="margin:0;">Events (Rehearsals, Concerts, Sectionals)</h3>
      <button class="btn secondary" onclick="refreshFromServer()" style="padding:6px 12px;">ðŸ”„ Refresh</button>
    </div>
    <div class="table-wrap">
      <div id="rehearsals-table"></div>
    </div>
    <button class="btn secondary" onclick="addEventRow()">Add event</button>
  </div>

  <!-- ===================== -->
  <!-- Allocation + schedule controls -->
  <!-- ===================== -->
  <div class="card">
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" onclick="runAllocation()">Run allocation</button>
      <button class="btn" onclick="generateSchedule()">Generate schedule</button>
      <button class="btn secondary" onclick="recomputeTimed()">Recompute timings</button>
    </div>
  </div>

  <!-- ===================== -->
  <!-- Allocation results    -->
  <!-- ===================== -->
  <div class="card" style="padding:0;">
    <div class="accordion-header collapsed" onclick="toggleAccordion(this)">
      <span class="toggle-icon">â–¼</span>
      <span>Allocation</span>
    </div>
    <div class="accordion-content" style="display: none; padding:20px;">
      <div id="allocation-table"></div>
    </div>
  </div>

  <!-- ===================== -->
  <!-- Schedule output       -->
  <!-- ===================== -->
  <div class="card" style="padding:0;">
    <div class="accordion-header collapsed" onclick="toggleAccordion(this)">
      <span class="toggle-icon">â–¼</span>
      <span>Schedule</span>
    </div>
    <div class="accordion-content" style="display: none; padding:20px;">
      <div id="schedule-table"></div>
    </div>
  </div>

  <!-- ===================== -->
  <!-- Timeline Editor       -->
  <!-- ===================== -->
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <h3 style="margin:0;">Timeline Editor</h3>
      <button class="btn secondary" type="button" onclick="toggleHistoryPanel()" style="padding:6px 12px;">ðŸ“‹ History</button>
    </div>
    <div class="small" style="margin-bottom:12px;">Drag works to reorder, drag edges to resize. Auto-saves with change log.</div>
    
    <!-- History Panel (hidden by default) -->
    <div id="historyPanel" style="display:none; margin-bottom:16px; padding:12px; background:#f5f5f5; border-radius:4px; max-height:300px; overflow-y:auto;">
      <div style="font-weight:bold; margin-bottom:8px;">Change History</div>
      <div id="historyList" style="font-size:0.85rem;"></div>
    </div>

    <!-- Timeline grid -->
    <div id="timelineEditor" style="margin-top:12px; background:white; border:1px solid #ddd; border-radius:4px; overflow-x:auto;">
      <div id="timelineContent"></div>
    </div>
  </div>

</body>

<!-- Editor logic -->
<script src="{{ url_for('static', filename='editor.js') }}"></script>

<script>
  // Bootstrap initial data from Flask â†’ editor.js
  window.INITIAL_DATA = {
    works: {{ works | tojson }},
    works_cols: {{ works_cols | tojson }},
    rehearsals: {{ rehearsals | tojson }},
    rehearsals_cols: {{ rehearsals_cols | tojson }},
    allocation: {{ allocation | tojson }},
    schedule: {{ schedule | tojson }},
    timed: {{ timed | tojson }},
    concerts: {{ concerts | tojson }},  // Add concerts for timeline editor
  };

  // Let editor.js initialise tables
  initEditor(window.INITIAL_DATA);
  
  // Populate sections editor
  function renderSectionsEditor() {
    const sectionsDiv = document.getElementById('sections-editor');
    if (!sectionsDiv) return;
    
    const rehearsals = window.INITIAL_DATA.rehearsals || [];
    
    // Sort by rehearsal number
    const sorted = rehearsals.sort((a, b) => {
      const numA = parseInt(a.Rehearsal);
      const numB = parseInt(b.Rehearsal);
      return numA - numB;
    });
    
    sectionsDiv.innerHTML = sorted.map(reh => `
      <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px; padding: 10px; background: #f9fafb; border-radius: 4px;">
        <div style="flex: 1;">
          <strong>Rehearsal ${reh.Rehearsal}</strong><br>
          <small style="color: #666;">${reh.Date || 'Date not set'}</small>
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <div>
            <label style="display: block; font-size: 0.85rem; margin-bottom: 4px; color: #666;">Event Type</label>
            <select class="event-type-input" data-rehearsal="${reh.Rehearsal}" 
                    style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
              <option value="Rehearsal" ${reh['Event Type'] === 'Rehearsal' ? 'selected' : ''}>Rehearsal</option>
              <option value="Sectional" ${reh['Event Type'] === 'Sectional' ? 'selected' : ''}>Sectional</option>
              <option value="Concert" ${reh['Event Type'] === 'Concert' ? 'selected' : ''}>Concert</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-size: 0.85rem; margin-bottom: 4px; color: #666;">Section</label>
            <input type="text" class="section-input" data-rehearsal="${reh.Rehearsal}" 
                   value="${reh.Section || 'Full Ensemble'}" placeholder="Full Ensemble"
                   style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; width: 180px;">
          </div>
          <button onclick="saveEventTypeAndSection(${reh.Rehearsal})" class="btn btn-sm" style="padding: 6px 12px; align-self: flex-end;">Save</button>
        </div>
      </div>
    `).join('');
  }
  
  // Save event type and section change
  async function saveEventTypeAndSection(rehearsalNum) {
    const eventTypeSelect = document.querySelector(`.event-type-input[data-rehearsal="${rehearsalNum}"]`);
    const sectionInput = document.querySelector(`.section-input[data-rehearsal="${rehearsalNum}"]`);
    if (!eventTypeSelect || !sectionInput) return;
    
    const eventType = eventTypeSelect.value.trim();
    const section = sectionInput.value.trim() || 'Full Ensemble';
    
    try {
      const response = await fetch(`/api/s/{{ schedule_id }}/rehearsal-event-type/${rehearsalNum}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 'Event Type': eventType, 'Section': section })
      });
      
      if (response.ok) {
        // Update STATE
        const rehearsal = STATE.rehearsals.find(r => parseInt(r.Rehearsal) === rehearsalNum);
        if (rehearsal) {
          rehearsal['Event Type'] = eventType;
          rehearsal['Section'] = section;
        }
        // Also update timed data
        STATE.timed.forEach(row => {
          if (parseInt(row.Rehearsal) === rehearsalNum) {
            row.Section = section;
          }
        });
        alert('Event type and section updated!');
      } else {
        alert('Error updating event type and section');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to update event type and section');
    }
  }
  
  async function handleCompleteScheduleUpload(scheduleId, file) {
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      const response = await fetch(`/api/s/${scheduleId}/import_complete_schedule`, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
      });
      
      if (response.ok) {
        const result = await response.json();
        alert(`Success! Uploaded ${result.rehearsals_rows} rehearsals and ${result.timed_rows} scheduled works.`);
        location.reload();
      } else {
        const error = await response.json();
        alert('Error: ' + (error.error || 'Failed to upload'));
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to upload: ' + error.message);
    }
    
    // Reset file input
    document.getElementById('upload-complete-schedule-form').reset();
  }
  
  // Render sections when page loads
  setTimeout(() => {
    renderSectionsEditor();
  }, 500);
</script>
{% endblock %}
